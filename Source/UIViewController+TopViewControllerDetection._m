//
//  UIViewController+TopViewControllerDetection.m
//
//  Created by Siarhei Ladzeika on 4/10/19.
//  Copyright Â© 2019 Siarhei Ladzeika. All rights reserved.
//

#import "UIApplication+TopViewControllerDetection.h"

static UIViewController* findTopViewController(UIViewController* base) {
    
    if ([base isKindOfClass:[UINavigationController class]]) {
        UINavigationController* const nav = (UINavigationController*)base;
        return findTopViewController(nav.visibleViewController);
    }
    else if ([base isKindOfClass:[UITabBarController class]]) {
        UITabBarController* const tab = (UITabBarController*)base;
        if (tab.selectedViewController) {
            return findTopViewController(tab.selectedViewController);
        }
    }
    else if (base.presentedViewController) {
        return findTopViewController(base.presentedViewController);
    }
    else if ([base.childViewControllers count] > 0) {
        
        __block UIViewController* lastViewController = nil;
        
        [[[base.childViewControllers reverseObjectEnumerator] allObjects] enumerateObjectsUsingBlock:^(__kindof UIViewController * _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
            if (obj.isViewLoaded
                && (obj.view.isHidden == NO)
                && (obj.view.alpha >= 0.05)
                && CGRectEqualToRect(base.view.bounds, obj.view.frame)
                )
            {
                lastViewController = obj;
                *stop = YES;
            }
        }];
        
        if (lastViewController) {
            if (CGRectEqualToRect(base.view.bounds, lastViewController.view.frame)) {
                return findTopViewController(lastViewController);
            }
        }
    }
    
    return base;
}

        
@implementation UIViewController(TopViewControllerDetection)

- (nullable UIViewController*)topViewController {
    return findTopViewController(self);
}

@end
